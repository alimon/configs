- hosts: all
  vars_files:
    ../vars/vars.yml
  tasks:
    - name: create build workspace
      file:
        path: "{{ build_dir }}"
        state: directory

    - name: install pytorch build requirements (CentOS)
      become: yes
      dnf:
        name:
          - cmake
          - gcc-c++
          - gcc-gfortran
          - lapack-devel
          - libjpeg-devel
          - libpng-devel
          - make
          - openblas-devel
          - patch
          - python3
          - python3-devel
          - python3-nose
          - python3-pillow
          - python3-setuptools
          - python3-virtualenv
          - python3-wheel
          - python3-yaml
        state: present
        enablerepo: PowerTools
      when: ansible_os_family == 'RedHat'

    - name: install pytorch build requirements (Debian)
      become: yes
      apt:
        name:
          - cmake
          - g++
          - gfortran
          - liblapack-dev
          - make
          - libblas-dev
          - libjpeg-dev
          - libpng-dev
          - patch
          - python3
          - python3-dev
          - python3-nose
          - python3-pil
          - python3-setuptools
          - python3-venv
          - python3-wheel
          - python3-yaml
        state: present
      when: ansible_os_family == 'Debian'

    - name: fetch pytorch source
      git:
        repo: "https://github.com/pytorch/pytorch.git"
        dest: "{{ build_dir }}/pytorch/"
        depth: 1
        recursive: yes
        force: yes

    - name: install Python packages required by pytorch
      pip:
        name:
          - cython
          - dataclasses
          - numpy==1.18.*
          - typing-extensions
        virtualenv: "{{ build_dir }}/virtualenv"
        virtualenv_command: "/usr/bin/python3 -m venv"
        virtualenv_site_packages: yes
      environment:
        NPY_NUM_BUILD_JOBS: "{{ ansible_processor_vcpus }}"

    - name: build pytorch
      shell:
        cmd: |
          set -xe
          source "{{ build_dir }}/virtualenv/bin/activate"
          USE_CUDA=0 BUILD_CAFFE2_OPS=0 USE_DISTRIBUTED=0 USE_QNNPACK=0 USE_XNNPACK=0 python3 setup.py bdist_wheel
        chdir: "{{ build_dir }}/pytorch/"
        creates: "{{ build_dir }}/pytorch/build/"
        executable: /bin/bash

    - name: get name of built wheel file
      find:
        path: "{{ build_dir }}/pytorch/dist/"
        patterns: "torch*.whl"
        file_type: file
      register: wheel_file

    - name: install pytorch Python package
      become: yes
      pip:
        name: "{{ wheel_file.files | map(attribute='path') | list }}"
        virtualenv: "{{ build_dir }}/virtualenv"

    - name: fetch pytorch vision source
      git:
        repo: "https://github.com/pytorch/vision.git"
        dest: "{{ build_dir }}/vision/"
        depth: 1
        recursive: yes
        force: yes

    - name: build pytorch vision
      shell:
        cmd: |
          set -xe
          source "{{ build_dir }}/virtualenv/bin/activate"
          python3 setup.py bdist_wheel
        chdir: "{{ build_dir }}/vision/"
        creates: "{{ build_dir }}/vision/build/"
        executable: /bin/bash

    - name: prepare wheels for publishing
      shell:
        cmd: |
          set -xe
          for pkg in "pytorch/dist/*.whl" "vision/dist/*.whl"
          do
            pkgdir=$(echo `basename $pkg`|cut -d'-' -f1 | tr '[:upper:]' '[:lower:]')
            mkdir -p "{{ build_dir }}/out/$pkgdir"
            cp $pkg  "{{ build_dir }}/out/$pkgdir"
          done
        chdir: "{{ build_dir }}/"
        creates: "{{ build_dir }}/out/torch/"
        executable: /bin/bash
