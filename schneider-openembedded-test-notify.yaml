- job:
    name: schneider-openembedded-test-notify
    project-type: freestyle
    defaults: global
    properties:
        - authorization:
            anonymous:
                - job-read
                - job-extended-read
                - job-workspace
            linaro:
                - job-build
                - job-cancel
        - build-discarder:
            days-to-keep: 30
            num-to-keep: 30
    disabled: false
    node: master
    concurrent: false
    display-name: 'Schneider OpenEmbedded Test Notify'
    wrappers:
        - timeout:
            timeout: 60
        - timestamps
    builders:
        - shell: |
            #!/bin/bash

            set -ex
            pwd
    publishers:
        - postbuildscript:
            builders:
                - role: MASTER
                  build-on:
                    - SUCCESS
                  build-steps:
                    - shell: |
                        echo "Combining CVEs"
                        #sort -u ${JENKINS_HOME}/jobs/${JOB_NAME}/configurations/axis-DISTRO/dip/axis-MACHINE/*/axis-label/docker-stretch-amd64/builds/${BUILD_NUMBER}/archive/cve-*.txt > cve.txt
                        sort -u ${JENKINS_HOME}/jobs/schneider-openembedded-warrior-4.19-rfs/configurations/axis-DISTRO/dip/axis-MACHINE/*/axis-label/docker-stretch-amd64/builds/31/archive/cve-*.txt > cve.txt
                        echo "HTMLify CVEs"
                        perl -F'\t' -lane '($type, $cve, $pkg, $url, @rest) = @F; push @{$foo{$type}}, ("<a href=\"$url\">$cve</a> $pkg" . list(@rest)); sub list { return @_ ? join("", "<ul>\n", map("<li>$_</li>\n", @_), "</ul>") : ""} ; END { foreach (reverse sort keys %foo) { print "<b>$_ CVEs</b>", list(@{$foo{$_}}) if @{$foo{$_}} }}' cve.txt > cve.html
                        echo "Summarize CVEs"
                        printf "NEW=%d CHANGED=%d FIXED=%d\n" `grep NEW cve.txt|wc -l` >cve.sum
        - email-ext:
            # Send custom email generated in jenkins job
            recipients: 'ralph.siemsen@linaro.org'
            subject: 'Schneider OpenEmbedded Test Notify'
            body: |
                $DEFAULT_CONTENT

                CVE summary: ${FILE,path="cve.sum"}
            attachments: "cve.html"
        - email:
             recipients: 'ralph.siemsen@linaro.org'
